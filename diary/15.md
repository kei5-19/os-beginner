# 15日目

<!-- mtoc-start -->

- [1. ウィンドウ描画はメインスレッドで](#1-ウィンドウ描画はメインスレッドで)
- [2. アクティブウィンドウ](#2-アクティブウィンドウ)

<!-- mtoc-end -->

## 1. ウィンドウ描画はメインスレッドで

ここを早くやりたかった。
この実装で描画のデッドロックがなくなるはず……。

今の実装だとウィンドウのアクセスに `LAYER_MANAGER` を使うので、
また引数を増やしてそこから `Option<&mut Window>` を渡すことに。
だいぶ強引だが、task_b 用のウィンドウを書き換えるやつは task_b しかいないので大丈夫なはず。
いやまあ覗くやつ（`LAYER_MANAGER`）はおるんから微妙なんやけど。

それで大丈夫かな～と思ったらまだ起こる。
で、よくよく見ていたら、そういえば当たり前だが `printk` でもレイヤーマネージャのロックを取得する。
ということで、`printk` の前後に `cli`, `sti` を入れるようにした。
それで大丈夫かな～と思ったら、まだたまに起こる。

デバッガを起動したところ、そこで止まったの初めて確認したけど、
`MEMORY_MANAGER`（メモリ割り当てとかをする）とこで止まっていた。
確かに。

ということでここも場当たり的に前後に `cli`, `sti` を入れることで強引に解決した。
強引すぎる。
まあ最初やし一旦いいか。

最初から書き直して～。

## 2. アクティブウィンドウ

最初は `WindowTrait` 的なものを用意して、`Box<dyn WindowTrait>` を使いまわそうとして実装していたが、
それでは `LAYER_MANAGER` というか `Layer` から `Window` を貰うときに困るということに気がついた。
なので、今までの `Window` を `WindowBase` とし、列挙型の `Window` を使うことで解決しようと思う。
