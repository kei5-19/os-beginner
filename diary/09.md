# 9日目

- [1. 重ね合わせ処理](#1-重ね合わせ処理)

### 0.1. いくつか修正・更新

- Mutex を作成
- RwLock を修正
- RwLock の大部分を Mutex に変更

  [詳解 Rustアトミック操作とロック](https://www.ohmsha.co.jp/book/9784814400515/) を読んだので、
  それを参考に色々修正したりした。

  あと大抵の構造体は `RwLock` より `Mutex` で持ったほうが良さそうだったので、
  それも修正した。

- Console の列、行の数を指定できるように変更

  元々は `Console` のバッファを `[[u8; COLUMN_NUM]; ROW_NUM]` みたいに持っていて、
  過去に1度、画面サイズが変わっても最大限表示できるように、この大きさを変えよとしたが、
  ジェネリクスとして `const ROW_NUM: usize` みたいなのを持たせるのは嫌で放置していた。
  
  ただ、今となっては `Box` が使えるようになったので、それでいいやんってなって、
  実装を変えた。

- log_cpp で複雑なフォーマットに対応

  上で `Console` の実装が変わったから、テストでもしてみるかと、
  ログレベルを下げて（？）色々と出力させてみたところ、
  `"%08x"` とか `"%ld"`（こっちは今の実装では同じやけど）とかが表示されなかったので、
  表示できるように実装を変えた。

  ここで Rust のフォーマットで

  ```rs
  format!(":0digit$x", num);
  ```

  みたいにすると、`digit` で桁数を変数で調整できることを知った。

### 0.2. 反省？

こういうのは Day8.5 とかで
やっておくべきだったし、絶対別のブランチでコミットしたほうがいいが、
まあ面倒なのでここに入れておく。

## 1. 重ね合わせ処理

Linux カーネルには `container_of()` という便利なマクロがあって、
調べてみたところ、これを使うと構造体のある要素へのポインタから、
構造体自体のポインタを得られるらしい。
中身を読んでみた感じ、Rust でも 1.77.0 で `offset_of!` というマクロが安定化したおかげで、
同じようなことができそうということが分かった。
（まあ教科書では使ってないから使わんけど）

と思ったけど、Rust で自己参照は無理や。
上手くいくか知らんけど、`WindowWriter` は `Window` に統合する方針で。

あと、メモリ割り当ては `BitmapMemoryManager` である程度の領域を振ってしまって、
その領域を順番に渡していくという方法を取っているらしい。

ここではすでに `BitmapMemoryManager` を直接使ってメモリ割り当てを実現しているので、
一旦このままでいく。
まあ、プロセスを動かすみたいになったら、プロセスごとに振ったりするのがいいのかなあ。

`Window`, `Layer` とかを実装した。
実装する時点で、所有権の問題とかでだいぶそのままではいかんかった。
ので、`LayerManager` の `Layer` の持ち方を、`BTreeMap<u32, Lyaer>` にして、
キーでレイヤーの ID を管理することにした。
それで、ID から `Layer` への排他参照を返すみたいな使い方をさせることに。

あとは、`Console` にどうやって `Window` を `PixelWriter` として渡すかという話がある。
`Console` は `&'static OnceMutex<Box<dyn PixelWriter + Send>>` を持たないといけないが、
`LayerManager` が所有している `Layer` が `Window` を所有するような構造で作ってしまったので、
おそらく難しい。

それでレイヤーの ID を持たせることにして、持っていたらそちらを使う、という実装にした。

あと、再描画に関して少しバグを出してしまった。
というのも `CONSOLE` に `Layer` を設定するときに、再描画を行っていたが、
その `writer` を昔のものでやっていた。
それを `Window` に変更したところ、デッドロックが発生。
そりゃそう。
なので、 `LAYER_MANAGER` のいろんな設定が終わってから、`CONSOLE` のレイヤーを設定することに。

あとは、 `Console` の方で書き込み後に `LAYERM_MANAGER` に描画してもらうのを忘れていたので、
その処理を追加した。

## 2. 謝罪

なんか書くのサボりながらやっていたら実装できて書こうと思った頃には何があったかだいぶ忘れました。
終。
