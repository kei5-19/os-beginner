# 4日目（2023/11/29）

## Make 入門

これは `cargo make`（もしくは `makers`）で行っているため、特にやることはない。
ただ、

```make
%.o: %.cpp
	cxx ...
```

のようにパターンマッチングで書けるというのが知れたのはでかい。

「GNU Make 第3版」は pdf を無料公開しているらしいのも知れた。

## ピクセルを自在に描く

フレームバッファの情報の何かがおかしいのか、実装がおかしいのか分からないがなにか変。

__結論__: ~~どちらもおかしい~~ 私が馬鹿なだけでした。

- 本当にアホだが、フレームバッファのベースアドレスを足すのを忘れていた
- ~~UEFI からの情報によると、解像度が 640x480 だが、本当は 800x600 になっている~~
- 本当は `GraphicsOutput::current_mode_info()` を呼ばなければならなかったが、
  愚かなことに `GraphicsOutput::query_mode()` という、設定可能な描画モードを取得する関数を使っていた

それに気づいたらすぐ解決した。

それと、今後は [mikan-os/](../mikan-os/) で作業していくことにする。

## ~~C++~~ Rust の機能を用いて書き直す

C++ は使っていないので、まあ Rust を使うしかない。
使うとしたらトレイトとトレイトオブジェクトになるだろうと思う。
ただ、トレイトオブジェクトを持つには、参照型（`&dyn`）にするか `Box` にするしかない。
後者はヒープを割り当てられないと使えないので、今はまだ無理。

そこで参照を使うしかないが、参照は当たり前だが、そのオブジェクトのスコープ内でしか使えないので、
確保済みのバッファを保持に使えるようにするような関数を作った。
ただ、その実装の何処かが悪く、思ったように動かない。

どこが悪いのかと思って、コピペを別環境でテストしてみたが、別に想定通りに動いた。
諦めてアセンブリを読み始めた。
`cmovX` とかいう、フラグレジスタを読んで、フラグが立っていたらコピーを行うという命令が x64 にあることを知った。

アセンブリを読んでも（全部四ではないけど）正常そうで、「どういうこと？」になったので、gdb を動かしました。
ちなみに、`qemu-system_* -s -S` とすると、qemu 起動時にプログラムが停止状態で始まるようになり、
localhost のポート 1234 を gdb のデバッグ用に使えるようになる。

それで発覚したのは、関数コール先のアドレスが正しくメモリに配置されたときのアドレスになっているため、
ちゃんと配置していない今は正常に動かないということだった。

つまり、一旦諦めて、正しい配置を行う次の実装を行うことにする。

## ローダを改良する

方針としては、カーネルを一次保存領域に読み込み、ヘッダの解析をして正しくメモリに展開する。
またも詰まったので、その点をメモしておく。
Copy トレイトが必要と言われていた時点で察するべきだったが、
元々 `kernel_buffer_addr: *mut u8` がカーネルを読み込んだメモリの番地を指していたときに、

```rs
let kernel_buffer = unsafe { *(kernel_buffer_addr as *const Elf64Ehdr) };
```

というようなことをすると、新しく他の場所にコピーされてしまうため、

```rs
&kernel_buffer as *const Elf64Ehdr as usize != kernel_buffer_addr as usize
```

となってしまう。
（これは Rust は、同じメモリに違う目的でアクセスしないように、
コピーを行うため（ここで Copy トレイトが要求される）だと思う。）

そのことに気がつくのに（デバッグ）時間がかかり、実装が遅くなった。

## Rust の機能を用いて書き直す（再訪）

これでこちらも上手く動くかと思ったが、失敗。
またデバッガとアセンブリを眺めていると、
どうもトレイトオブジェクト用のバッファに値を入れるところがないように見えた。

`slice::as_ptr()` で生ポインタを取得していた。
これは、ローダの方で `slice::as_mut_ptr()` を使ったら、「余計だ」と忠告を吐かれた覚えが合ったからだ。

でも、もしかして駄目なのかと思い、
[リファレンス](https://doc.rust-lang.org/std/primitive.slice.html#method.as_ptr) を見たところ、
なんか可変にはできなさそうなことが書いてある。

というわけで、`slice::as_mut_ptr()` を使うようにしたところ解決した。
アホらし。
なんの勘違いなんだ。

ここの過程で、デバッグ用の Makefile レシピと、シェルスクリプトを追加した。
まあとても便利という訳では無いが、ある程度使えそう。
