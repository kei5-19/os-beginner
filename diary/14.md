# 14日目

<!-- mtoc-start -->

- [1. スリープしてみる](#1-スリープしてみる)
- [2. イベントが来たら起床する](#2-イベントが来たら起床する)

<!-- mtoc-end -->

## 1. スリープしてみる

教科書では `Task` のポインタからでもスリープしたりできるようにしているが、
とりあえずこちらは `id` しか受け付けないようにした。

あとは、`TASK_MANAGER` の使い方がだいぶ怪しいが、まあ教科書と同じなので大丈夫ではあるはず。
ただ、同じタイミングで同じタスクに対して `sleep()` とか `wake_up()` 呼んだらまずいやろなあ……。
まあシングルコアやし、最初の方に初期化しておしまいやから今は大丈夫（なはず）。

## 2. イベントが来たら起床する

ここの機能がメインタスクへの描画依頼に必要。

~~教科書のミスじゃない？ポイント発見。
リスト 14.14 で~~

```cpp
__asm__("cli");
auto msg = main_task.ReceiveMessage();
if (!msg) {
    main_task.Sleep();
    __asm__("sti");
    continue;
}
```

~~ってあるんやけど、ここの `Sleep()` と `sti` 逆じゃないか？
スリープさせると別のタスクに移動するはずで、
そうすると割り込みが許可されないまま別のタスクに移ってしまうことになる。~~

と思ったけど、コンテキストスイッチのときにフラグが移動先のコンテキストのもので設定し直されるから大丈夫や。
