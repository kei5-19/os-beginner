# 27日目

<!-- mtoc-start -->

- [1. デマンドページ](#1-デマンドページ)

<!-- mtoc-end -->

## 1. デマンドページ

まず、`custom_attribute` に自前で実装した割り込みハンドラのプロローグ、
エピローグの処理が間違っていたので修正した。

まず今まで多分割り込みハンドラの処理でそんな変なことをしていないから問題が起きていなかったが、
関数呼び出しの前の RSP を16の倍数に調整して置かなければならないのを忘れていた。
（今回も別にこれで問題が起きたわけではない）

あとこっちが致命的で、どこかのタイミングでエラーコードがある場合の処理を追加したが、
このとき割り込み後のスタックが

```text
| error code |
|     RIP    |
|     CS     |
|   RFLAGS   |
|     RSP    |
|     SS     |
```

というように積まれているので、エラーコードがない場合と違って `iret` の呼び出し前に
RSP を +8 しないといけないが、それを忘れていた。
そのせいで今まで見たことない `iret` での一般保護例外が出てビックリした（CS とかの値がおかしいと出るらしい）。

あとは AT&T シンタックスと intel シンタックスに騙されました。
CR2 を取得するのに（intel シンタックスで）

```asm
mov rax, cr2
ret
```

みたいなことをしないといけないが、最近どちらも見るせいで逆に書いてしまっていた。アホ。

デマンドページングシステムコールを追加したことで、
アプリ側でもページ割り当てが行えるようになったので、
app-lib に `global_allocator` を追加した。
ただし、ライブラリに `global_allocator` を実装すると、
柔軟性が効かなくて困りそうだなと思って色々と調べた感じ、
こういうことに feature を使えばいいことに気がつけた。

ということで、まず alloc feature をオンにすると
`alloc` クレートを使うようにし、`GlobalAllocator` を実装した `Global` を提供する。
そして global_alloc feature もオンにすると（勝手に alloc feature もオンになる）、
`global_allocator` として宣言した実体の `Global` を使えるという風にした。

いや～、feature 便利ですね。

で、これまでのアプリは `alloc` クレートが使えなくても動くものだから、
テストも兼ねて app-lib の default-features をオフにしておいた。

その上で、app-lib で alloc feature がオンになっている場合は
今まで固定長のバッファでやりくりしていたところを `Vec` とかを使うように変更した。
これで滅多なことではエラーにならないはず。
