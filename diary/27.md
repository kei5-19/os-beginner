# 27日目

<!-- mtoc-start -->

- [1. デマンドページ](#1-デマンドページ)

<!-- mtoc-end -->

## 1. デマンドページ

まず、`custom_attribute` に自前で実装した割り込みハンドラのプロローグ、
エピローグの処理が間違っていたので修正した。

まず今まで多分割り込みハンドラの処理でそんな変なことをしていないから問題が起きていなかったが、
関数呼び出しの前の RSP を16の倍数に調整して置かなければならないのを忘れていた。
（今回も別にこれで問題が起きたわけではない）

あとこっちが致命的で、どこかのタイミングでエラーコードがある場合の処理を追加したが、
このとき割り込み後のスタックが

```text
| error code |
|     RIP    |
|     CS     |
|   RFLAGS   |
|     RSP    |
|     SS     |
```

というように積まれているので、エラーコードがない場合と違って `iret` の呼び出し前に
RSP を +8 しないといけないが、それを忘れていた。
そのせいで今まで見たことない `iret` での一般保護例外が出てビックリした（CS とかの値がおかしいと出るらしい）。
