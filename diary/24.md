# 24日目

<!-- mtoc-start -->

- [1. ターミナルを増やす](#1-ターミナルを増やす)
- [2. カーソル点滅を自分で](#2-カーソル点滅を自分で)
- [3. 複数アプリの同時起動](#3-複数アプリの同時起動)
- [4. ウィンドウの重なりのバグ修正](#4-ウィンドウの重なりのバグ修正)
- [5. ターミナル無しのアプリ起動](#5-ターミナル無しのアプリ起動)
- [6. OS をフリーズさせるアプリ](#6-os-をフリーズさせるアプリ)
- [7. OS を守ろう (2)](#7-os-を守ろう-2)

<!-- mtoc-end -->

## 1. ターミナルを増やす

変更自体は簡単。
ただ、2つのターミナルで2つのアプリを実行すると、
2つのアプリが使うページが被っているためいろんな CPU 例外が発生する。
多分あとで CR3 を変更して動くようにするんやと思う。

## 2. カーソル点滅を自分で

特に言うことはない。

が、教科書の実装では点滅用のタイマーがアプリ起動中に来て、
そのアプリが `read_event()` システムコールを呼んでいるとタイマ通知が潰されてしまって
その後絶対に点滅しなくなる。
ということでこれでいいかは不明だが一応直した。

## 3. 複数アプリの同時起動

[23日目](./23.md) に言っていた CR3 変更来た。
最近やってきたやつの中で一番嬉しい。

ただ、`set_cr3()` 呼んでから `task.context.cr3` を変更するまでの間にタイマ割り込みで
コンテキストスイッチしたらマズイ気がするんやけど、割り込み禁止せんくて大丈夫なんやろうか。

## 4. ウィンドウの重なりのバグ修正

これは実は commit d2c6061869ccd51a9d7ebc5dfb03f3d1641f32b9 で修正している。

## 5. ターミナル無しのアプリ起動

まあできたけど、たまによく分からん `panic()` が発生するし、
デッドロックっぽいのが発生する。
デッドロックっぽいのは、タイマカウントとマウス、キーボードが動かんくなるけど、
起動したアプリの表示とかは止まらない。
ってことは `LAYER_MANAGER` のデッドロックではないし、
`TIMER_MANAGER` のデッドロックでもないってことやけど、じゃあなに？
意味不明です。
デバッガ使えんの痛い。

## 6. OS をフリーズさせるアプリ

CPU 例外を発生させるおもちゃ作った。
ただ、Rust でゼロ除算は `panic()` になってしまって、CPU 例外にならんから、
アホらしいけどアセンブリで書いた。

## 7. OS を守ろう (2)

アプリがゼロ除算やページフォルトなどの CPU 例外を発生させたときは、
OS を止めるのではなく強制終了してしまおうという話。
よくある OS に近づいてきて嬉しい。

そういえば割り込みのときは割り込みが禁止されて、`iret` で戻るでもない限り
明示的に IF を立てないといけないのを忘れていた。
（`iret` の場合は戻るときに下のフラグ状態に戻る）
