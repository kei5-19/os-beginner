# 28日目

<!-- mtoc-start -->

- [1. 日本語と文字コード](#1-日本語と文字コード)
- [2. 日本語フォント](#2-日本語フォント)

<!-- mtoc-end -->

## 1. 日本語と文字コード

Rust は純正で UTF-8 にバリバリ対応しているので、わざわざバイト列からの変換を自前で書く必要はない。
なので書かなかった。
その代わり `String` を使い得るからヒープ使うけどまあいいやろ。

## 2. 日本語フォント

[IPA フォント](https://moji.or.jp/ipafont/ipa00303/) を使うらしい。
まあなに使ってもいいやろうけど真似る。

だいぶ苦戦した！
教科書は FreeType という C ライブラリを使っていて、
まあもちろん FreeType の静的ライブラリとリンクして、
適切な構造体とかを定義、ライブラリの関数を `extern` で宣言するとかやれば使える。
だろうが、面倒で回避したかった。

ということで、とりあえず Rust で FreeType を使えるライブラリを探した。
見つからんかったわけではないけど、`no_std` で使えるやつが少ない！

- [freetype-rs](https://github.com/PistonDevelopers/freetype-rs)
  FreeType をそのまま使えそうなラッパーで良さそうやったけど、`no_std` では使えない
- [freetype-sys](https://github.com/PistonDevelopers/freetype-sys)
  freetype-rs ほどラップしてなくて、`unsafe` が必要そう。
  こちらも同様に使えない

FreeType そのものは無理そうだと諦めて True Type とか Open Type で調べ始めた。
そうしたら [allsorts_no_std](https://crates.io/crates/allsorts_no_std) とかいう、
[allsorts](https://github.com/yeslogic/allsorts) の `no_std` 版みたいなのが見つかった。
良さそうと思ったけど、allsorts と比較して全然更新されてないし、
そのせいかライブラリのコンパイルでエラーを吐かれた。

ということでまた別のライブラリを探してようやく
[rusttype](https://gitlab.redox-os.org/redox-os/rusttype) というのが見つかった。
ちょっと使い方は違いそうやけど、やりたいことは Rust っぽく実現できそうだったので、
（あんま使い方の説明がなかったので）サンプルとか見ながら書いてみた。

使い方としては、

1. ttf のバイナリを読み込んで `Font` を作る（特定のフェースに対して作られる）
2. `Font` と `char` かグリフ番号から `Glyph` を作る
3. 大きさと位置を指定して `PositionedGlyph` にする

ここまですると、指定した大きさと位置情報を持ったフォントのビットマップに `Positioned::draw()` を使って
アクセスできるようになるので、描画していく。

ただ、使ってみた感じ位置の指定が左上じゃなくて左下になっているのでそこでちょっと詰まった。
あと `Font::v_metrics().ascent` を使うと、そのフォントの全文字の高さの最大が得られるらしいので、
それを使って描画位置を調整。
そのあと `PositionedGlyph::pixel_bounding_box()` を使うと上と下の余白がもらえるので、
ピクセルを描いていく向きに応じて位置を調整してやると上手くいくみたい。

ローダーで読み込むファイルサイズは変えなくても特に読み込み失敗はしていないが、
一応増やしといた。
あと教科書ではタスクとアプリのスタックサイズも変更しているが、
後者はデマンドページングのところで 8 MB までは自動で伸びるようにしたので放置。
