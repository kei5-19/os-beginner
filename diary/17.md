# 17日目

<!-- mtoc-start -->

- [1. ファイルとファイルシステム](#1-ファイルとファイルシステム)
- [2. BIOS パラメータブロック](#2-bios-パラメータブロック)
- [3. ディレクトリエントリ](#3-ディレクトリエントリ)
- [4. ボリュームを読み出す](#4-ボリュームを読み出す)

<!-- mtoc-end -->

## 1. ファイルとファイルシステム

楽しそうで素晴らしい。
fat12 を去年 OS の授業で、宿題やったからほぼ自力で勉強したけど、もう殆ど覚えてなくて悲しいねえ。
まあ次の節でちゃんと見るっぽいしいいか。

## 2. BIOS パラメータブロック

パーティションの先頭1ブロックを **PBR**（Partition Boot Record）というらしい。
確か fat の先頭は MBR（Master Boot Record）で最初の方に起動時に読まれる命令、
その後パーティション情報と MBR であることの signature（ブートフラグ）があったはずやけど、
ここで作ったボリュームイメージでは1つのパーティションを作ったことになっているらしい。
[FAT32ファイルシステム読解](https://zenn.dev/hidenori3/articles/3ce349c02e79fa) をちょっと読んだ。
教科書でもある程度詳しく見てそうだったので、こちらはちょっとしか読んでない。

で、パーティションの先頭は **BPB**（BIOS Parameter Block）。
ここで昔アセンブリだけで作った OS の方を見てみると、こちらも同じ形式になっていたので、
パーティション情報がなかったら先頭から始まる1つのパーティションとして見るとかそういう話な気がする
（というかそういう話な気がしてきた）。

あと、いくつか思い出してきて、FAT というのはそもそもどのセクターがどう繋がっているかみたいなテーブルで、
それがバックアップ用に2つあるというのはなんとなく覚えていた。
で、確か先頭2セクタは予約されていて、その後ルートディレクトリが続く。
ディレクトリの構造は忘れてしまったが、FAT には今のセクターが使われているか、
使われているなら続きのセクターがあるか、
続きがあるならどのセクターが入っているかという情報が入っていたのを思い出した。

ただ見てみた感じフラグも含まれているのか？　という気もした。
詳細は続きを読んでいけば分かるだろう。

あ、あとはディレクトリエントリというか、ファイル名について。
ファイル名は名前用に8バイト、拡張子用に3バイトの領域があるというのも覚えていた。

## 3. ディレクトリエントリ

まあ読むだけ。
[FATファイルシステムの仕組みと操作法 #ディレクトリ構造体](http://elm-chan.org/docs/fat.html#fat_struct)
ここらへんが同じような内容書いてそう。
というか去年 OS の講義で宿題するときに参考にしたのここな気がするな。

## 4. ボリュームを読み出す

またブートローダにテコ入れが要るらしい。
まあ前作った OS でもファイル周りは BIOS に丸投げたったし、
ドライバを作るのが大変そうなのは何となく分かるので想像はできてましたが……。

ところで、カーネルに渡す引数の数が6を超えるとマズイんやけど、普通に超えそうで困る。
なんで教科書はカーネルがロードされる場所渡さんくてもなんとかなっとるんや？
