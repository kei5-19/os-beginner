# 12日目

<!-- mtoc-start -->

- [1. FADT を探す](#1-fadt-を探す)
- [2. ACPI PM タイマを使う](#2-acpi-pm-タイマを使う)
- [3. USB キーボードドライバ](#3-usb-キーボードドライバ)
- [4. モディファイアキー](#4-モディファイアキー)
- [5. テキストボックス](#5-テキストボックス)

<!-- mtoc-end -->

## 1. FADT を探す

x86 やったときもこんなんあったな～ってなりながらやってます。
ただ、`packed` が多すぎる！
なんでこんな構造なんや。
おかげで `unsafe` まみれです。
まあ、全部 [acpi.rs](../mikan-os/kernel/src/acpi.rs) に収まっとるからいいけど……。

## 2. ACPI PM タイマを使う

特に言う事無し。

## 3. USB キーボードドライバ

久しぶりに C++ のマングリング触らされた。
あと、マウスのときと同様に `HIDKeyboardDriver::SetDefaultObserver` っていう関数を作った。
多分そうじゃないと設定できんから。

Rust 側にも `HIDKeyboardDriver` 作ったけど、現状これは要らんな。
まあいいけど。

## 4. モディファイアキー

キーボードの修飾キーについての情報を得るために USB ドライバをアップデートした。
なんか要らんものもついてきたけど、こないだ学んだ `git add -p <file>` とかいう、
diff を見ながら細かくコミットに加えるか指定していくやつを使って結構楽に要るもんだけコミットした。

現状は修飾キーが押されただけでは通知せず、修飾キー以外が押されたときに押されている修飾キー情報と一緒にもらう
みたいな実装らしいんやけど、それはちょい微妙な気がする。

例えば Windows とかやと、alt キー単体を押すことに意味があったりするし。
まあ動けばいいからそんな高度（？）なことする必要はまったくないんやけど。

HID 機器は機器自身に **レポートディスクリプタ** っていうボタンの数とかデータ構造が分かるやつを内蔵させておいて、
OS 側がそれを読み取ってデータを解釈するという方法を取るらしい。

ただそれやと面倒やから、キーボードとマウスには **ブートインターフェース** っていう規格もあって、
ブートローダとか UEFI とかの複雑なことはしたくないソフトでも楽に動かせるようになっているらしい。
教科書が用意してくれているデバイスドライバはそれを使っているらしいです。

あー、あとは vim に関することやけど、
選択範囲の小文字を大文字にしたいときは `U`、大文字を小文字にしたいときは `u`、
大文字小文字を反転させたいときは `~` を打つとできるらしい。
あと、置換で同じことをしたいときは、正規表現で使う `\1` とかの前に `\L` をつければ小文字、
`\U` をつければ大文字になるらしい。

## 5. テキストボックス

教科書では文字をテキスト用ウィンドウに描画するのに `InputTextWindow()` なる関数を使っているが、
Rust で同じようなことはやりづらいと思うので、一旦生で埋め込んだ。
